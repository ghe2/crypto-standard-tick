define(["backbone","Handlebars","QuickBase","select2","moment","css!./css/app.css"],function(t,e,u,i,n){"use strict";o.getComponentDefinition=function(t){var e={id:1998,componentName:"Trade",componentDescription:"Trade",appKey:"Trade",css:"Trade",listViewThumb:null,ghostViewThumb:null,buildViewThumb:null,appArgs:{websiteUrl:t.websiteUrl,json:{version:"4.7.2",Basics:{Connection:"",Theme:"Dark",Symbols:"",Panels:"",ColorIncrease:"#D1FED9",ColorDecrease:"#FAD7D6",Cells:6,WeightedAverage:"VWAP"},Style:{advanced:"",BarColor:"#b0c4de",BarTextColor:"#000000",BarFontSize:10,FontColor:"#000000",FontSize:10,MinorPriceSize:16,MajorPriceSize:25,PrePriceSize:12,MaxPanels:0,TickerTimeout:0}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Settings",options:{collapsed:!1},propertyOrder:200,properties:{Connection:{type:"dataConnection",title:"Data Connection"},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Dark","Light"]},DashboardTheme:{options:{hidden:!0}},Symbols:{type:"data",format:"string",title:"Symbols",default:""},Panels:{type:"string",default:"",title:"Panels"},ColorIncrease:{default:"#D1FED9",title:"Quote Up",type:"gradient",options:{gradient:!1,noColor:!0}},ColorDecrease:{default:"#",title:"Quote Down",type:"gradient",options:{gradient:!1,noColor:!0}},Cells:{default:6,title:"Number of Cells",type:"number",minimum:1,maximum:15},WeightedAverage:{type:"string",title:"Weighted Average",default:"VWAP",enum:["VWAP","TWAP"]}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:210,properties:{advanced:{type:"css",title:"Advanced CSS",default:""},BarColor:{default:"#b0c4de",title:"Bar Color",type:"gradient",options:{gradient:!1,noColor:!0}},BarTextColor:{default:"#000000",title:"Bar Text Color",type:"gradient",options:{gradient:!1,noColor:!0}},BarFontSize:{default:10,title:"Bar Font Size",type:"number"},FontColor:{default:"#000000",title:"Default Text Color",type:"gradient",options:{gradient:!1,noColor:!0}},FontSize:{default:10,title:"Default Font Size",type:"number"},MinorPriceSize:{default:16,title:"Minor Price Font Size",type:"number"},MajorPriceSize:{default:25,title:"Major Price Font Size",type:"number"},PrePriceSize:{default:12,title:"PreMajor Price Font Size",type:"number"},MaxPanels:{default:0,title:"Number of Cells",type:"number"},TickerTimeout:{default:0,title:"Highlight Change Duration (ms)",type:"number"}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(var i=_.find(o.upgrades,{version:t.settingsModel.get("version")}),n=void 0===i?1:o.upgrades.indexOf(i)+1;n<o.upgrades.length;n+=1){var s=o.upgrades[n];s.fn(t.settingsModel,t),t.settingsModel.set("version",s.version)}return e},o.upgrades=[{version:"4.6.0",fn:function(){}},{version:"4.7.0",fn:function(t){t=t.get("Basics");t.Cells=void 0===t.Cells?6:t.Cells,t.WeightedAverage=void 0===t.WeightedAverage?"VWAP":t.WeightedAverage}},{version:"4.7.2",fn:function(t){t=t.get("Style");t.BarColor=_.isNil(t.BarColor)?"#b0c4de":t.BarColor,t.BarTextColor=_.isNil(t.BarTextColor)?"#000000":t.BarTextColor,t.BarFontSize=_.isNil(t.BarFontSize)?10:t.BarFontSize,t.FontColor=_.isNil(t.FontColor)?"#000000":t.FontColor,t.FontSize=_.isNil(t.FontSize)?10:t.FontSize,t.MinorPriceSize=_.isNil(t.MinorPriceSize)?16:t.MinorPriceSize,t.MajorPriceSize=_.isNil(t.MajorPriceSize)?25:t.MajorPriceSize,t.PrePriceSize=_.isNil(t.PrePriceSize)?12:t.PrePriceSize,t.MaxPanels=_.isNil(t.MaxPanels)?0:t.MaxPanels,t.TickerTimeout=_.isNil(t.TickerTimeout)?0:t.TickerTimeout}}];var s=o;function o(){}a.app=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){return'<div class="host">\n</div></div>\n<div class="cmenu">\n  <ul class="cmenu-options">\n    <li class="cmenu-option"><i class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp; New Trade Panel</li>\n   \n  </ul>\n'},useData:!0}),a.floorCodes=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){return'<div class="floorCodeDiv">\n    <div class="lfloorCodediv">\n        <table>\n            <tr class="lfloorCode"></tr>\n        </table>\n    </div>\n    <div class="floorCodedivdetails">#Floor Codes</div>\n    <div class="rfloorCodediv">\n        <table>\n            <tr class="rfloorCode"></tr>\n            </table< /div>\n    </div>'},useData:!0}),a.graph=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){return'<table class="graphTable">\n    <tr></tr>\n</table>'},useData:!0}),a.quote=e.template({1:function(t,e,i,n,s){return'    <div class="tick"><i></i></div>\n    <span class="pre"></span>\n    <span class="major"></span>\n    <span class="minor"></span>\n'},3:function(t,e,i,n,s){return'    <span class="pre"></span>\n    <span class="major"></span>\n    <span class="minor"></span>\n    <div class="tick"><i></i></div>\n'},compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){var o,a=null!=e?e:t.nullContext||{},r=t.hooks.helperMissing,l=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="side">'+t.escapeExpression("function"==typeof(o=null!=(o=l(i,"side")||(null!=e?l(e,"side"):e))?o:r)?o.call(a,{name:"side",hash:{},data:s,loc:{start:{line:1,column:18},end:{line:1,column:26}}}):o)+'</div>\n<div class="quoteBox">\n'+(null!=(o=(l(i,"eq")||e&&l(e,"eq")||r).call(a,null!=e?l(e,"side"):e,"Offer",{name:"eq",hash:{},fn:t.program(1,s,0),inverse:t.program(3,s,0),data:s,loc:{start:{line:3,column:4},end:{line:13,column:11}}}))?o:"")+"</div>"},useData:!0}),a.settingsMenu=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){return'<div class="row aggregation">\n    <div class="label">Aggregation</div>\n    <div class="control">\n        <select style="width: 100%" class="select-agg">\n            <option value="Exact">Exact Agg</option>\n            <option value="One">One-Level Agg</option>\n            <option value="Two">Two-Level Agg</option>\n        </select>\n    </div>\n</div>\n<div class="row viewer-highlight">\n    <div class="label">Price Highlight</div>\n    <div class="control">\n        <select style="width: 100%" class="select-highlight">\n            <option value="On">On</option>\n            <option value="Off">Off</option>\n        </select>\n    </div>\n</div>\n\n'},useData:!0}),a.tradePanel=e.template({1:function(t,e,i,n,s){var o=t.escapeExpression,a=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'            <option value="'+o(t.lambda(e,e))+'">'+o((a(i,"t")||e&&a(e,"t")||t.hooks.helperMissing).call(null!=e?e:t.nullContext||{},e,{name:"t",hash:{},data:s,loc:{start:{line:8,column:37},end:{line:8,column:47}}}))+"</option>\n"},compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){var o,a=null!=e?e:t.nullContext||{},r=t.hooks.helperMissing,l=t.escapeExpression,h=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div>\n    <div class="drag">\n        \n         <div class="security" style="width:30%">\n        <select style="width: 100%" class="select-sym">\n            <option value="'+l("function"==typeof(o=null!=(o=h(i,"sym")||(null!=e?h(e,"sym"):e))?o:r)?o.call(a,{name:"sym",hash:{},data:s,loc:{start:{line:6,column:27},end:{line:6,column:34}}}):o)+'">'+l((h(i,"t")||e&&h(e,"t")||r).call(a,null!=e?h(e,"sym"):e,{name:"t",hash:{},data:s,loc:{start:{line:6,column:36},end:{line:6,column:45}}}))+"</option>\n"+(null!=(o=h(i,"each").call(a,null!=e?h(e,"securities"):e,{name:"each",hash:{},fn:t.program(1,s,0),inverse:t.noop,data:s,loc:{start:{line:7,column:11},end:{line:9,column:21}}}))?o:"")+'        </select>\n    </div>\n        <a class="remove"><i class="fa fa-times"></i></a>\n        <a class="settings"><i class="fa fa-cog"></i></a>\n        <span class="preset"></span>\n        <div class="settings-menu"></div>\n    </div>\n    <div class="lQuote">\n        <span class="vol">Total Vol:<span class="val"></span></span>\n        <div class="price">\n        </div>\n    </div>\n    <div class="rQuote">\n        <span class="vol">Total Vol:<span class="val"></span></span>\n        <div class="price">\n        </div>\n    </div>\n    <div class="graphArea">\n        <div class="lGraph"></div>\n        <div class="graphDetails"></div>\n        <div class="rGraph"></div>\n    </div>\n    <div class="rad"></div>\n    <div class="vwap">\n    </div>\n    <div class="floorCodes">\n    </div>\n</div>'},useData:!0}),a.vwap=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,s){return'<div class="vwapDiv">\n    <div class="lvwapdiv">\n        <table>\n            <tr class="lVWAP1"></tr>\n            <tr class="lVWAP2"></tr>\n        </table>\n    </div>\n    <div class="vwapdivdetails">\n        <table>\n            <tr><td class="VWAP1"></td></tr>\n            <tr><td class="VWAP2"></td></tr>\n        </table>\n    </div>\n    <div class="rvwapdiv">\n        <table>\n            <tr class="rVWAP1"></tr>\n            <tr class="rVWAP2"></tr>\n        </table>\n    </div>\n</div>'},useData:!0});var r=a;function a(){}h.getRoundedRateAsString=function(t,e,i,n){n=1===n?e:.1===n?e+1:.01===n?e+2:.001===n?e+3:1e-4===n?e+4:1e-5===n?e+5:e;return t=h.roundDec(t,9),(i?h.roundDecUp(t,n):h.roundDecDown(t,n)).toFixed(n).toString()},h.roundDec=function(t,e){e=Math.pow(10,e);return Math.round(t*e)/e},h.roundDecDown=function(t,e){e=Math.pow(10,e),t=this.roundDec(t*e,2);return Math.round(Math.floor(t))/e},h.roundDecUp=function(t,e){e=Math.pow(10,e),t=this.roundDec(t*e,2),t=Math.ceil(t);return Math.round(t)/e},h.prototype.updateFonts=function(){this.setFontSizeMajor(),this.setFontSizeMinor(),this.setFontSizePre()},h.prototype.getPrice=function(){return""+this.pre+this.major+this.minor},h.prototype.setFontSizeMajor=function(){var t=this.api.getProperty(h.MAJORFONT);this.majorEl.style.fontSize=t+"px"},h.prototype.setFontSizeMinor=function(){var t=this.api.getProperty(h.MINORFONT);this.minorEl.style.fontSize=t+"px"},h.prototype.setFontSizePre=function(){var t=this.api.getProperty(h.PREFONT);this.preEl.style.fontSize=t+"px"},h.prototype.updatePrice=function(t,e){var i,n,s,o,a,r=this;t&&e?t!==this.price&&(i=0,n=this.api.getProperty("Basics.ColorIncrease"),s=this.api.getProperty("Basics.ColorDecrease"),o=(e=h.getRoundedRateAsString(t,1,this.isAskSide,e).split("")).pop(),a=e.pop(),a=""+e.pop()+a,e=e.join(""),this.price&&(i=this.price===t?0:t>this.price?1:-1),this.setPre(e),this.setMajor(a),this.setMinor(o),this.setTick(i),this.setSide(),this.el.title=e+""+a+o,"On"===this.highlight&&(this.price&&t>this.price?this.quoteBox.style.backgroundColor=n:this.price&&t<this.price?this.quoteBox.style.backgroundColor=s:this.quoteBox.style.backgroundColor="",this.timeout&&(this.clearTimeout(),this.highlightTimeout=setTimeout(function(){r.quoteBox.style.backgroundColor="transparent"},this.timeout))),this.price=t):(this.price=void 0,this.setPre(""),this.setMajor(""),this.setMinor(""),this.setTick(0),this.setSide(),this.el.title="")},h.prototype.updateHighlight=function(t){t||(this.quoteBox.style.backgroundColor=""),this.highlight=t},h.prototype.updateTimeout=function(t){this.clearTimeout(),this.timeout=t},h.prototype.remove=function(){this.clearTimeout()},h.prototype.clearTimeout=function(){this.highlightTimeout&&(clearTimeout(this.highlightTimeout),this.highlightTimeout=void 0)},h.prototype.setMajor=function(t){t!==this.major&&(this.major=t,this.majorEl.textContent=t)},h.prototype.setMinor=function(t){t!==this.minor&&(this.minor=t,this.minorEl.textContent=t)},h.prototype.setSide=function(){this.sideEl.textContent=this.isAskSide?"Offer":"Bid"},h.prototype.setPre=function(t){t!==this.pre&&(this.pre=t,this.preEl.textContent=t)},h.prototype.setTick=function(t){var e=this.tick;switch(t){case-1:e=h.TICK_DOWN;break;case 0:e=h.TICK_OFF;break;case 1:e=h.TICK_UP}e!==this.tick&&(this.tickEl.className=this.tick=e)},h.TICK_UP="fa fa-caret-up",h.TICK_OFF="fa fa-caret-up",h.TICK_DOWN="fa fa-caret-down",h.MAJORFONT="Style.MajorPriceSize",h.MINORFONT="Style.MinorPriceSize",h.PREFONT="Style.PrePriceSize",h.PROP_TICK_TIMEOUT="Style.TickerTimeout";var l=h;function h(t,e,i,n){this.el=t,this.isAskSide=e,this.tick=h.TICK_OFF,this.el.innerHTML=r.quote({side:n}),this.highlight="On",this.api=i,this.timeout=i.getProperty(h.PROP_TICK_TIMEOUT),this.majorEl=this.el.getElementsByClassName("major")[0],this.minorEl=this.el.getElementsByClassName("minor")[0],this.preEl=this.el.getElementsByClassName("pre")[0],this.tickEl=this.el.querySelector(".tick > i"),this.sideEl=this.el.getElementsByClassName("side")[0],this.quoteBox=this.el.querySelector(".quoteBox"),this.setFontSizeMajor(),this.setFontSizeMinor(),this.setFontSizePre()}m.getTickTokens=function(t,e){var t=l.getRoundedRateAsString(t,1,!0,e).split(""),e=t.pop(),i=t.pop();return[""+t.pop()+i+e,t.join("")]},m.updateVWAP=function(t,e,i,n,s,o,a,r,l){for(var h,p,u=function(t,e){t=m.getTickTokens(t,o);return e===a?["",""]:[t[0],t[1]]},c=0,d=Math.min(i,s.length);c<d;c++){var g=u(n.getValue(s[c]),c);t&&!_.isNaN(t.children[c])&&_.get(t.children[c],"textContent")&&(t.children[c].textContent=g[0],t.children[c].style.fontSize=r+"px",t.children[c].style.color=l),e&&!_.isNaN(e.children[c])&&_.get(e.children[c],"textContent")&&(e.children[c].textContent=g[1],e.children[c].style.fontSize=r+"px",e.children[c].style.color=l)}if(c<s.length)for(h=new DocumentFragment,p=new DocumentFragment;c<s.length;c++){var g=u(n.getValue(s[c]),c),f=document.createElement("td"),f=(f.classList.add("cell-"+s.length),f.textContent=g[0],f.style.fontSize=r+"px",f.style.color=l,h.appendChild(f),document.createElement("td"));f.classList.add("cell-"+s.length),f.textContent=g[0],f.style.fontSize=r+"px",f.style.color=l,p.appendChild(f)}for(;c<i;c++)t&&t.lastChild&&t.removeChild(t.lastChild),e&&e.lastChild&&e.removeChild(e.lastChild);return h&&t.appendChild(h),p&&e.appendChild(p),c},m.prototype.resetCount=function(){this.leftCount=0,this.rightCount=0,_.each([this.leftRow1,this.leftRow2,this.rightRow1,this.rightRow2],function(t){for(;t&&t.lastChild;)t.removeChild(t.lastChild)})},m.prototype.update=function(t,e,i,n,s,o,a){this.leftCount=m.updateVWAP(this.leftRow1,this.leftRow2,this.leftCount,t,e,n,e.length-1,o,a),this.rightCount=m.updateVWAP(this.rightRow1,this.rightRow2,this.rightCount,t,i,n,0,o,a),s&&(t=n!==Math.floor(n)?n.toString().split(".")[1].length:0,i=s.getValue(0)+s.getValue(e.length-1),this.wapNum.innerText=""+(i/2).toFixed(t+2))},m.prototype.updateWeightAvgText=function(t){this.wapText.innerText=t};var p=m;function m(t){this.el=t,this.leftCount=0,this.rightCount=0,this.el.innerHTML=r.vwap(),this.leftRow1=this.el.getElementsByClassName("lVWAP1")[0],this.rightRow1=this.el.getElementsByClassName("rVWAP1")[0],this.leftRow2=this.el.getElementsByClassName("lVWAP2")[0],this.rightRow2=this.el.getElementsByClassName("rVWAP2")[0],this.wapNum=this.el.getElementsByClassName("VWAP2")[0],this.wapText=this.el.getElementsByClassName("VWAP1")[0]}d.updateFloor=function(t,e,i,n,s){for(var o,a=function(t){return null===t?"":""+t},r=0,l=Math.min(e,n.length);r<l;r++)t&&t.children[r]&&!_.isNil(_.get(t.children[r],"textContent"))&&(t.children[r].textContent=a(i.getValue(n[r])),t.children[r].style.fontSize=s+"px");if(r<n.length)for(o=new DocumentFragment;r<n.length;r++){var h=document.createElement("td");h.classList.add("cell-"+n.length),h.textContent=a(i.getValue(n[r])),h.style.fontSize=s+"px",o.appendChild(h)}for(;r<e;r++)t&&t.lastChild&&t.removeChild(t.lastChild);return o&&t.appendChild(o),r},d.prototype.update=function(t,e,i,n){this.leftCount=d.updateFloor(this.leftRow,this.leftCount,t,e,n),this.rightCount=d.updateFloor(this.rightRow,this.rightCount,t,i,n)},d.prototype.resetCount=function(){this.leftCount=0,this.rightCount=0,_.each([this.leftRow,this.rightRow],function(t){for(;t&&t.lastChild;)t.removeChild(t.lastChild)})};var c=d;function d(t){this.el=t,this.leftCount=0,this.rightCount=0,this.el.innerHTML=r.floorCodes(),this.leftRow=this.el.getElementsByClassName("lfloorCode")[0],this.rightRow=this.el.getElementsByClassName("rfloorCode")[0]}f.prototype.resetCount=function(){for(this.count=0;this.row&&this.row.lastChild;)this.row.removeChild(this.row.lastChild)},f.prototype.update=function(e,t,i){for(var n,s=function(t){return""+t*i},o=_.max(t.map(function(t){return Number(e.getScalar(t))})),a=0,r=Math.min(this.count,t.length);a<r;a++){var l,h=Number(e.getScalar(t[a]));this.row&&this.row.children[a]&&_.get(this.row.children[a],"firstChild")&&((l=this.row.children[a].firstChild).textContent=h?s(h):"",l.style.height=(f.HEIGHT*h/o).toFixed(1)+"px",l.style.backgroundColor=this.barColor,l.style.fontSize=this.barFontSize+"px",l.style.color=this.barTextColor)}if(a<t.length)for(n=new DocumentFragment;a<t.length;a++){var h=Number(e.getScalar(t[a])),p=document.createElement("td"),u=(p.classList.add("cell-"+t.length),document.createElement("span"));u.textContent=h?s(h):"",u.style.height=(f.HEIGHT*h/o).toFixed(1)+"px",u.style.backgroundColor=this.barColor,u.style.fontSize=this.barFontSize+"px",u.style.color=this.barTextColor,p.appendChild(u),n.appendChild(p)}for(;a<this.count;a++)this.row&&this.row.lastChild&&this.row.removeChild(this.row.lastChild);n&&this.row.appendChild(n),this.count=a},f.prototype.updateGraph=function(t,e){_.set(this,this.getPropertyKey(e),t)},f.prototype.getPropertyKey=function(t){t=t.replace("Style.","");return t.charAt(0).toLowerCase()+t.slice(1)},f.HEIGHT=40;var g=f;function f(t,e,i,n){this.el=t,this.count=0,this.barColor="#b0c4de",this.barTextColor="#000000",this.barFontSize=10,this.el.innerHTML=r.graph(),this.row=this.el.getElementsByTagName("tr")[0],this.barColor=e,this.barTextColor=i,this.barFontSize=n}y.prototype.updatePriceFonts=function(){var t;null!=(t=this.lQuote)&&t.updateFonts(),null!=(t=this.rQuote)&&t.updateFonts()},y.prototype.updateGraph=function(t,e){var i;null!=(i=this.lGraph)&&i.updateGraph(t,e),null!=(i=this.rGraph)&&i.updateGraph(t,e)},y.prototype.closeSelect=function(){$(this.selectSym).select2("close")},y.prototype.destroy=function(){var t;this.dataModel.unsubscribe(this.cid),this.el.remove(),null!=(t=this.lQuote)&&t.remove(),null!=(t=this.rQuote)&&t.remove(),this.appView.onResize()},y.prototype.getSettings=function(){return this.settings},y.prototype.onData=function(t,e){e=e.cols;if(e[y.MDEntryType].qtype!==u.ipc.TypeNum.Byte||e[y.MDEntryPx].qtype!==u.ipc.TypeNum.Double||e[y.PROP_FLOOR].qtype!==u.ipc.TypeNum.Int||e[y.MDEntrySize].qtype!==u.ipc.TypeNum.Long)throw"Invald Market Data Snapshot";for(var i=e[y.MDEntryType],n=e[y.MDEntryPx],s=e[y.PROP_FLOOR],o=e[y.MDEntrySize],e="VWAP"===this.api.getProperty(y.WEIGHTEDAVERAGE)?e[y.MDVWAP]:e[y.MDTWAP],a=[],r=[],l=0;l<i.length;l++){var h=i.getValue(l);h===y.MDEntryType_Bid&&a.push(l),h===y.MDEntryType_Offer&&r.push(l)}null!=(p=this.lQuote)&&p.updatePrice(a.length?n.getValue(a[0]):void 0,this.settings.pipSize),null!=(p=this.rQuote)&&p.updatePrice(r.length?n.getValue(r[0]):void 0,this.settings.pipSize);var p=_.reverse(a),n=(this.vwap.update(n,p,r,this.settings.pipSize,e,this.api.getProperty(y.FONT_SIZE),this.api.getProperty(y.FONT_COLOR)),this.floorCode.update(s,p,r,this.api.getProperty(y.FONT_SIZE)),this.lGraph.update(o,p,1e-6),this.rGraph.update(o,r,1e-6),_.sum(a.map(function(t){return o.getScalar(t)}))),e=_.sum(a.map(function(t){return o.getScalar(t)}));this.ltotalVol.textContent=1e-6*Number(n)+"MM",this.rtotalVol.textContent=1e-6*Number(e)+"MM"},y.prototype.resize=function(){},y.prototype.changeTimeout=function(t){var e;null!=(e=this.lQuote)&&e.updateTimeout(t),null!=(e=this.rQuote)&&e.updateTimeout(t)},y.prototype.changeAggregation=function(t){this.getAggregations(t)},y.prototype.changeHighlight=function(t){var e;null!=(e=this.lQuote)&&e.updateHighlight(t),null!=(e=this.rQuote)&&e.updateHighlight(t)},y.prototype.getAggregations=function(t){"One"===t?$(this.el.getElementsByClassName("preset")).text("One-Level Agg"):"Two"===t?$(this.el.getElementsByClassName("preset")).text("Two-Level Agg"):"Exact"===t&&$(this.el.getElementsByClassName("preset")).text("Exact Agg")},y.prototype.setPipSize=function(){var e=this,t=_.filter(this.securities,function(t){return t.sym===e.settings.sym});this.settings.pipSize=0<t.length?t[0].pipsize:1e-4},y.prototype.onSettingChange=function(){this.dataModel.unsubscribe(this.cid),this.rGraph.resetCount(),this.lGraph.resetCount(),this.floorCode.resetCount(),this.vwap.resetCount(),this.dataModel.set("_connection",this.api.getProperty(y.PROP_CONNECTION));this.dataModel.set("_selectedAnalytic",{Exact:"book",One:"book1Agg",Two:"book2Agg"}[this.getSettings().aggregation]),this.dataModel.set("_analyticParams",[{index:0,type:"list",value:[this.settings.sym]}]),this.dataModel.subscribe(this.cid,this,!0)},y.prototype.createDDM=function(){return new u.DocumentDataModel({_forceReset:!0,_subscriptionKey:"",_dataType:"analytic",_subscriptionType:"streaming"},null,"FX_streaming_ddm_"+this.cid,void 0,void 0)},y.PROP_CONNECTION="Basics.Connection",y.WEIGHTEDAVERAGE="Basics.WeightedAverage",y.MDEntrySize="MDEntrySize",y.MDEntryPx="MDEntryPx",y.MDEntryType="MDEntryType",y.MDEntryType_Bid=0,y.MDEntryType_Offer=1,y.PROP_FLOOR="FloorCode",y.MDVWAP="MDVWAP",y.MDTWAP="MDTWAP",y.BAR_COLOR="Style.BarColor",y.BAR_TEXT_COLOR="Style.BarTextColor",y.BAR_TEXT_SIZE="Style.BarFontSize",y.FONT_SIZE="Style.FontSize",y.FONT_COLOR="Style.FontColor";var P=y;function y(t,e,i){var n=this,i=(this.cid=_.uniqueId("trade-panel"),this.maxPanels=0,this.settings=t,this.el=document.createElement("div"),this.el.className="tradePanel",this.el.draggable=!0,this.securities=i,this.el.innerHTML=r.tradePanel({sym:t.sym,securities:_.map(_.reject(this.securities,{sym:t.sym}),"sym")}),this.appView=e,this.api=e.api,this.getAggregations(t.aggregation),this.el.getElementsByClassName("settings")[0]);this.settingsMenu=this.el.getElementsByClassName("settings-menu")[0],i.addEventListener("click",function(t){return $(n.settingsMenu).fadeToggle(150),$(n.settingsMenu).position({my:"right top",at:"right bottom",of:t.target}),!1}),this.settingsMenu.innerHTML=r.settingsMenu(),this.selectSym=this.el.getElementsByTagName("select")[0],$(this.selectSym).select2({theme:"Trade",minimumResultsForSearch:5,maximumDisplayOptionsLength:10}).data("select2").$dropdown.addClass("Trade"),$(this.selectSym).on("select2:select",function(){n.settings.sym=n.selectSym.value,n.setPipSize(),n.onSettingChange(),n.appView.updatePanel(n.settings)}),this.$selectAgg=this.el.getElementsByClassName("select-agg")[0],this.$selectAgg.addEventListener("change",function(){var t=n.$selectAgg.value;n.settings.aggregation=t,n.changeAggregation(t),n.onSettingChange(),n.appView.updatePanel(n.settings),$(n.settingsMenu).fadeOut(180)}),this.$selectHighlight=this.el.getElementsByClassName("select-highlight")[0],this.$selectHighlight.addEventListener("change",function(){var t="On"===n.$selectHighlight.value;n.changeHighlight(t),n.settings.highlight=t,n.appView.updatePanel(n.settings),$(n.settingsMenu).fadeOut(180)}),this.$selectHighlight.value=t.highlight;this.el.getElementsByClassName("remove")[0].addEventListener("click",function(){n.appView.onPanelsRemoved(n.settings),n.destroy()});var e=this.el.querySelector(".lQuote > .price"),i=this.el.querySelector(".rQuote > .price"),t=this.el.querySelector(".vwap"),s=this.el.querySelector(".floorCodes"),o=this.el.querySelector(".lGraph"),a=this.el.querySelector(".rGraph");if(!e||!i)throw"missing elememts";this.lQuote=new l(e,!1,this.api,"Bid"),this.rQuote=new l(i,!0,this.api,"Offer"),this.vwap=new p(t),this.vwap.updateWeightAvgText(this.api.getProperty(y.WEIGHTEDAVERAGE)),this.floorCode=new c(s),this.lGraph=new g(o,this.api.getProperty(y.BAR_COLOR),this.api.getProperty(y.BAR_TEXT_COLOR),this.api.getProperty(y.BAR_TEXT_SIZE)),this.rGraph=new g(a,this.api.getProperty(y.BAR_COLOR),this.api.getProperty(y.BAR_TEXT_COLOR),this.api.getProperty(y.BAR_TEXT_SIZE)),this.ltotalVol=this.el.querySelector(".lQuote > .vol > .val"),this.rtotalVol=this.el.querySelector(".rQuote > .vol > .val"),this.dataModel=this.createDDM(),this.onSettingChange()}var v=function(t,e){this.x=t,this.y=e},C=function(t){this.view=t,this.visible=!1,this.column=0,this.position=new v(0,0),this.size=new v(1,1),this.targetPosition=new v(0,0),this.targetSize=new v(1,1)},S=(T.prototype.updateBookCells=function(t){this.bookCells!==t&&(this.bookCells=t,this.updateMinimumWidth(),this.debouncedLayout(!1))},T.prototype.updateMinimumWidth=function(){this.minimumWidgetSize.w=T.MIN_CELL_WIDTH*this.bookCells*2+T.VWAP_TEXT_WIDTH},T.prototype.add=function(e){var i=this;0===this.maxPanel||this.panelInfos.length<this.maxPanel?(this.panelInfos.push(new C(e)),e.el.getElementsByClassName("drag")[0].addEventListener("mousedown",this.onViewDragHandleDown.bind(this)),e.el.addEventListener("dragover",function(t){return i.onViewDragOver(t)},!0),e.el.addEventListener("dragstart",function(t){return i.onViewDragStart(e.el,t)},!0),e.el.addEventListener("dragend",function(t){return i.onViewDragEnd(e.el,t)},!0),e.el.addEventListener("drop",function(t){return t.preventDefault()},!0),e.el.style.visibility="hidden",this.el.appendChild(e.el),e.resize(),this.debouncedLayout(!1)):new u.WarningDialog.ShowWarning("The upper limit of "+this.maxPanel+" trading panels that can be added has been reached.")},T.prototype.onViewDragHandleDown=function(t){this.dragHandle=t.target},T.prototype.onViewDragStart=function(e,t){t.target.contains(this.dragHandle)?(this.draggingPanelInfo=_.find(this.panelInfos,function(t){return t.view.el===e}),this.draggingPanelInfo&&(this.draggingPanelInfo.view.closeSelect(),this.draggingPanelInfo.view.el.style.zIndex="0",this.draggingPanelInfo.view.el.style.opacity="0.2",t.dataTransfer.effectAllowed="move",t.dataTransfer.setData(u.Tools.isIE()?"Text":"fxp/magic",this.draggingPanelInfo.view.cid))):t.preventDefault()},T.prototype.onViewDragOver=function(e){var t,i,n=this,s=_.find(this.panelInfos,function(t){return t.view.el.contains(e.target)});if(e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!s||s===this.draggingPanelInfo||-1!==this.movingSet.indexOf(s))return!1;var o=this.panelInfos.indexOf(s);if(0<=o&&o<this.panelInfos.length&&this.draggingPanelInfo&&(t=this.panelInfos.indexOf(this.draggingPanelInfo))!==o){if(this.movingSet.push(s),t<o){for(i=t;i<o;i+=1)this.panelInfos[i]=this.panelInfos[i+1];this.panelInfos[o]=this.draggingPanelInfo}else{for(i=t;o<i;--i)this.panelInfos[i]=this.panelInfos[i-1];this.panelInfos[o]=this.draggingPanelInfo}_.delay(function(){n.movingSet=n.movingSet.slice(1)},500),this.updateLayout2(!0)}return!1},T.prototype.onViewDragEnd=function(t,e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),$(t).css("opacity","1"),this.draggingPanelInfo=void 0,this.debouncedLayout(!1),this.orderChanged(this.panelInfos.map(function(t){return t.view}))},T.prototype.setRowsAndColumns=function(){var t,e,i=0;if(0!==this.panelInfos.length){for(this.columns=Math.max(1,Math.floor(this.el.offsetWidth/this.minimumWidgetSize.w)),this.columnHeights=[],t=0;t<this.columns;t+=1)this.columnHeights.push(0);for(0;;0){1;{for(e=0;e<this.columns&&i!==this.panelInfos.length;e+=1)this.panelInfos[i].column=e,i+=1;if(i===this.panelInfos.length)break}}}},T.prototype.remove=function(e){this.panelInfos=_.reject(this.panelInfos,function(t){return t.view===e}),this.throttleLayout(!1)},T.prototype.removeAll=function(){_.each(this.panelInfos,function(t){t.view.destroy()}),this.panelInfos=[],this.updateLayout2(!0)},T.prototype.updateMaxPanel=function(t){this.maxPanel=t},T.prototype.updateLayout2=function(t){var i=this;this.setRowsAndColumns();for(var e=0;e<this.columns;e+=1)this.columnHeights[e]=0;this.panelInfos.forEach(function(t){t.targetPosition=new v(t.column*(100/i.columns),i.columnHeights[t.column]),t.size.x!==100/i.columns&&(t.size.x=100/i.columns,t.view.el.style.width=t.size.x.toFixed(3)+"%"),t.visible||(t.visible=!0,t.view.el.style.visibility="visible");var e=Math.max(0,t.view.el.offsetHeight);i.columnHeights[t.column]+=e}),this.animationTimeElapsed=t?0:this.ANIMATION_TIME,this.lastFrame=Date.now(),window.requestAnimationFrame(this.renderFrame.bind(this))},T.prototype.renderFrame=function(){var n,s=this,t=Date.now(),e=t-this.lastFrame;this.lastFrame=t,this.animationTimeElapsed+=e,this.lastFrame=t,this.animationTimeElapsed>=this.ANIMATION_TIME?this.panelInfos.forEach(function(t){t!==s.draggingPanelInfo&&(t.view.el.style.top=t.targetPosition.y+"px",t.view.el.style.left=t.targetPosition.x.toFixed(3)+"%",t.position.x=t.targetPosition.x,t.position.y=t.targetPosition.y)}):(n=this.animationTimeElapsed/this.ANIMATION_TIME,this.panelInfos.forEach(function(t){var e,i;t!==s.draggingPanelInfo&&(e=t.position.x+(t.targetPosition.x-t.position.x)*n,i=t.position.y+(t.targetPosition.y-t.position.y)*n,t.view.el.style.top=i+"px",t.view.el.style.left=e.toFixed(3)+"%")}),window.requestAnimationFrame(this.renderFrame.bind(this)))},T.prototype.updateLayout=function(i){var n=this;this.setRowsAndColumns();for(var t=0;t<this.columns;t+=1)this.columnHeights[t]=0;this.panelInfos.forEach(function(t){var e=t.view.el.offsetHeight;(!e||e<0)&&(e=0),t.view.el.style.top=n.columnHeights[t.column]+"px",t.view.el.style.left=(t.column*(100/n.columns)).toFixed(3)+"%",t.view.el.style.width=(100/n.columns).toFixed(3)+"%",t.view.el.style.transitionDuration="0.3s",t.view.el.style.transitionProperty=i?"top, left":"none",n.columnHeights[t.column]+=e})},T.MIN_CELL_WIDTH=22.5,T.VWAP_TEXT_WIDTH=100,T);function T(t,e,i){this.panelInfos=[],this.animationTimeElapsed=0,this.columnHeights=[],this.columns=12,this.minimumWidgetSize={w:400,h:100},this.dragHandle=null,this.movingSet=[],this.ANIMATION_TIME=300,this.lastFrame=Date.now(),this.bookCells=6,this.maxPanel=0,this.el=t,this.orderChanged=e,this.panelRemoved=i,this.debouncedLayout=_.debounce(this.updateLayout2.bind(this),100),this.throttleLayout=_.throttle(this.updateLayout2.bind(this),100),this.updateMinimumWidth()}function O(t){var e=this,i=(this.ignoreSettingsChange=!1,this.tradingPanels=[],this.securities=[],this.api=t.api,this.el=t.el,this.el.className="Trade",this.uid=_.uniqueId(this.el.className),this.el.innerHTML=r.app({uid:this.uid}),this.host=new S(this.el.firstChild,this.onOrderChanged.bind(this),this.onPanelsRemoved.bind(this)),this.onResize(),this.contextMenu=this.el.querySelector(".cmenu"),this.contextMenuItem=this.el.querySelector(".cmenu-option"),null==(i=null==(i=null==(i=this.el.parentElement)?void 0:i.parentElement)?void 0:i.parentElement)?void 0:i.parentElement);i&&(i.addEventListener("contextmenu",function(t){return t.preventDefault(),e.setPosition(_.get(t,"pageX"),_.get(t,"pageY")),!1}),window.addEventListener("click",function(){return e.showContextMenu(!1)})),this.contextMenuItem.addEventListener("click",function(){e.showContextMenu(!1),e.addPanel()}),this.setTheme(t.dashboardViewModel.get(O.APP_THEME))}return O.prototype.onPanelsRemoved=function(e){var i=this;_.each(_.filter(this.host.panelInfos,function(t){return t.view.getSettings().id===e.id}),function(t){i.host.remove(t.view)}),this.tradingPanels=_.filter(this.tradingPanels,function(t){return t.id!==e.id}),this.setIgnoreSettings(!0),this.api.setProperty(O.PROP_PANELS,JSON.stringify(this.tradingPanels)),this.setIgnoreSettings(!1)},O.prototype.onResize=function(){this.host.updateLayout(!1)},O.prototype.onSettingsChange=function(t){this.callIfDef(t,O.PROP_PANELS,this.onPanelsPopulate.bind(this)),this.callIfDef(t,O.PROP_SYMBOL_LIST,this.onSymbols.bind(this)),this.callIfDef(t,O.PROP_COL_INC,this.onPanelsPopulate.bind(this)),this.callIfDef(t,O.PROP_COL_DEC,this.onPanelsPopulate.bind(this)),this.callIfDef(t,O.PROP_TICK_TIMEOUT,this.updateTimeout.bind(this)),this.callIfDef(t,O.PROP_CELLS,this.onCellsChanged.bind(this)),this.callIfDef(t,O.PROP_WEIGHTEDAVERAGE,this.onPanelsPopulate.bind(this)),this.callIfDef(t,O.PROP_MAJORFONT,this.updatePricePanel.bind(this)),this.callIfDef(t,O.PROP_MINORFONT,this.updatePricePanel.bind(this)),this.callIfDef(t,O.PROP_PREFONT,this.updatePricePanel.bind(this)),this.callIfDef(t,O.PROP_BARCOLOR,this.updateGraphView.bind(this,{prop:O.PROP_BARCOLOR})),this.callIfDef(t,O.PROP_BAR_TEXT_COLOR,this.updateGraphView.bind(this,{prop:O.PROP_BAR_TEXT_COLOR})),this.callIfDef(t,O.PROP_BAR_FONT_SIZE,this.updateGraphView.bind(this,{prop:O.PROP_BAR_FONT_SIZE})),this.callIfDef(t,O.PROP_FONT_SIZE,this.updateGraphView.bind(this,{prop:O.PROP_FONT_SIZE})),this.callIfDef(t,O.PROP_FONT_COLOR,this.updateGraphView.bind(this,{prop:O.PROP_FONT_COLOR})),this.callIfDef(t,O.PROP_MAXPANEL,this.updateMaxPanel.bind(this)),this.tradingPanels},O.prototype.remove=function(){return this.host.removeAll(),this.el.remove(),this},O.prototype.setTheme=function(t){this.el.classList.remove("Light"===t?"Dark":"Light"),this.el.classList.add(t),this.renderTradingPanels()},O.prototype.updatePanel=function(e){var t=_.findIndex(this.tradingPanels,function(t){return t.id===e.id});0<=t&&(this.tradingPanels[t]=e),this.setIgnoreSettings(!0),this.api.setProperty(O.PROP_PANELS,JSON.stringify(this.tradingPanels)),this.setIgnoreSettings(!1)},O.prototype.updatePricePanel=function(){_.each(this.host.panelInfos,function(t){t.view.updatePriceFonts()})},O.prototype.updateTimeout=function(){var e=this;_.each(this.host.panelInfos,function(t){t.view.changeTimeout(e.api.getProperty(O.PROP_TICK_TIMEOUT))})},O.prototype.updateGraphView=function(i){var n=this;_.each(this.host.panelInfos,function(t){var e=_.get(i,"prop");e&&t.view.updateGraph(n.api.getProperty(e),e)})},O.prototype.onPanelsPopulate=function(){var t=this.api.getProperty(O.PROP_PANELS);this.ignoreSettingsChange||(this.tradingPanels=[],this.host.removeAll(),t&&(this.tradingPanels=JSON.parse(t),this.securities&&this.renderTradingPanels()))},O.prototype.setPosition=function(t,e){this.contextMenu.style.left=t+"px",this.contextMenu.style.top=e+"px",this.showContextMenu(!0)},O.prototype.showContextMenu=function(t){this.contextMenu.style.display=t?"block":"none"},O.prototype.onCellsChanged=function(){this.host&&this.host.updateBookCells(this.api.getProperty(O.PROP_CELLS))},O.prototype.addPanel=function(){var e=_.uniq(_.map(this.tradingPanels,function(t){return t.sym})),t=_.filter(this.securities,function(t){return 0===e.length||e.indexOf(t.sym)<0}),i=this.tradingPanels?this.tradingPanels.length:0,n=_.maxBy(this.tradingPanels,"id");0<t.length&&(n={aggregation:"Exact",highlight:!0,id:n?n.id+1:1,order:i,pipSize:t[0].pipsize,sym:t[0].sym},this.host.add(new P(n,this,this.securities)),null!=(i=this.tradingPanels)&&i.push(n),this.setIgnoreSettings(!0),this.api.setProperty(O.PROP_PANELS,JSON.stringify(this.tradingPanels)),this.setIgnoreSettings(!1))},O.prototype.renderTradingPanels=function(){var t,i=this;this.tradingPanels&&0<this.securities.length&&(t=_.orderBy(this.tradingPanels,"order"),_.each(t,function(t){var e=_.map(i.host.panelInfos,function(t){return t.view.getSettings().id});_.indexOf(e,t.id)<0&&i.host.add(new P(t,i,i.securities))}))},O.prototype.callIfDef=function(t,e,i){void 0!==t[e]&&i.call(this,t[e],e)},O.prototype.onOrderChanged=function(t){var i=this;_.each(t,function(t,e){t.getSettings().order=e;t=_.findIndex(i.tradingPanels,{id:t.getSettings().id});i.tradingPanels[t].order=e}),this.setIgnoreSettings(!0),this.api.setProperty(O.PROP_PANELS,JSON.stringify(this.tradingPanels),{silent:!0}),this.setIgnoreSettings(!1)},O.prototype.updateMaxPanel=function(){this.host.updateMaxPanel(this.api.getProperty(O.PROP_MAXPANEL))},O.prototype.setIgnoreSettings=function(t){this.ignoreSettingsChange=t},O.prototype.onSymbols=function(t){var n=this;this.dataSource&&this.api.unsubscribe(this.dataSource),this.dataSource=t,this.securities=[],this.dataSource&&this.api.subscribe(this.dataSource,function(t,e){var i=[];_.each(e.collection.models,function(t){i.push({sym:t.get(O.PROP_SYMBOL),pipsize:t.get(O.PROP_PIPSIZE)})}),n.securities=i,n.renderTradingPanels()})},O.getComponentDefinition=s.getComponentDefinition,O.PROP_BASICS="Basics",O.APP_THEME="DashboardTheme",O.PROP_PANELS="Basics.Panels",O.PROP_SYMBOL_LIST="Basics.Symbols",O.PROP_COL_INC="Basics.ColorIncrease",O.PROP_COL_DEC="Basics.ColorDecrease",O.PROP_CELLS="Basics.Cells",O.PROP_WEIGHTEDAVERAGE="Basics.WeightedAverage",O.PROP_MAJORFONT="Style.MajorPriceSize",O.PROP_MINORFONT="Style.MinorPriceSize",O.PROP_PREFONT="Style.PrePriceSize",O.PROP_BARCOLOR="Style.BarColor",O.PROP_BAR_TEXT_COLOR="Style.BarTextColor",O.PROP_BAR_FONT_SIZE="Style.BarFontSize",O.PROP_FONT_SIZE="Style.FontSize",O.PROP_MAXPANEL="Style.MaxPanels",O.PROP_FONT_COLOR="Style.FontColor",O.PROP_TICK_TIMEOUT="Style.TickerTimeout",O.PROP_SYMBOL="sym",O.PROP_PIPSIZE="pipsize",O});